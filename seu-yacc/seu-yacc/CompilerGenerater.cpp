#include "stdafx.h"
#include "CompilerGenerater.h"
int CompilerGenerater::generateLR(const string& tplPath, const string& outPath) {
	FILE* outFile = fopen(outPath.c_str(), "w");
	
	ifstream tplfile(tplPath);
	string stpl((istreambuf_iterator<char>(tplfile)), istreambuf_iterator<char>());
	const char *tpl = stpl.c_str();
	string lrTable;

	lrTable += "int action[][";
	lrTable += to_string(lrbuilder.lrTable[0].size());
	lrTable+="] = {\n";
	for (size_t i = 0; i < lrbuilder.lrTable.size(); i++) {
		lrTable += "{";
		for (size_t j = 0; j < lrbuilder.lrTable[i].size(); j++) {
			lrTable += to_string((int)lrbuilder.lrTable[i][j].action);
			lrTable += " ,";
		}
		lrTable += "},\n";
	}
	lrTable += "};\n";
	lrTable += "int target[][";
	lrTable += to_string(lrbuilder.lrTable[0].size());
	lrTable += "] = {\n";
	for (int i = 0; i < (int)lrbuilder.lrTable.size(); i++) {
		lrTable += "{";
		for (int j = 0; j < (int)lrbuilder.lrTable[i].size(); j++) {
			lrTable += to_string(lrbuilder.lrTable[i][j].target);
			lrTable += " ,";
		}
		lrTable += "},\n";
	}
	lrTable += "};\n";
	string productions;
	auto &productionManager = lrbuilder.productionManager;
	productions += "int productions[][10]={\n";
	for (auto& pro : productionManager.productions) {
		//[id,left,num,right....]
		productions += "{";
		productions += to_string(pro.first);
		productions += ",";
		productions += pro.second.left.name + ",";
		productions += to_string(pro.second.right.size()) + ",";
		for (const auto& r : pro.second.right) {
			productions += r.name + ",";
		}
		productions += "}\n";
	}
	productions += "};\n";
	fprintf(outFile, tpl, reader.userHeader.c_str(), lrTable.c_str(), productions.c_str(), reader.userCode.c_str());
	fclose(outFile);
	return 0;
}
int CompilerGenerater::generateTableHLR(const string& outPath) {
	ofstream stream(outPath);
	stream << "//auto generated by seu-yacc\n";
	stream << "#ifndef _TABLE_H\n";
	stream << "#define _TABLE_H\n\n\n";
	for (auto& token : reader.tokenManager.tokens) {
		stream << "#define " << token.first << " " << token.second << '\n';
	}
	stream << "\n#endif\n";
	return 0;
}



int CompilerGenerater::generateLALR(const string& tplPath, const string& outPath) {
	FILE* outFile = fopen(outPath.c_str(), "w");

	ifstream tplfile(tplPath);
	string stpl((istreambuf_iterator<char>(tplfile)), istreambuf_iterator<char>());
	const char *tpl = stpl.c_str();
	string lrTable;

	lrTable += "int action[][";
	lrTable += to_string(lalrbuilder.lrTable[0].size());
	lrTable += "] = {\n";
	for (size_t i = 0; i < lalrbuilder.lrTable.size(); i++) {
		lrTable += "{";
		for (size_t j = 0; j < lalrbuilder.lrTable[i].size(); j++) {
			lrTable += to_string((int)lalrbuilder.lrTable[i][j].action);
			lrTable += " ,";
		}
		lrTable += "},\n";
	}
	lrTable += "};\n";
	lrTable += "int target[][";
	lrTable += to_string(lalrbuilder.lrTable[0].size());
	lrTable += "] = {\n";
	for (int i = 0; i < (int)lalrbuilder.lrTable.size(); i++) {
		lrTable += "{";
		for (int j = 0; j < (int)lalrbuilder.lrTable[i].size(); j++) {
			lrTable += to_string(lalrbuilder.lrTable[i][j].target);
			lrTable += " ,";
		}
		lrTable += "},\n";
	}
	lrTable += "};\n";
	string productions = "//[id,left,num,right....]\n";

	auto &productionManager = lalrbuilder.productionManager;
	productions += "int productions[][10]={\n";
	for (auto& pro : productionManager.productions) {
		//[id,left,num,right....]
		productions += "{";
		productions += to_string(pro.first);
		productions += ",";
		productions += pro.second.left.name + ",";
		productions += to_string(pro.second.right.size()) + ",";
		for (const auto& r : pro.second.right) {
			productions += r.name + ",";
		}
		productions += "}\n";
	}
	productions += "};\n";
	fprintf(outFile, tpl, reader.userHeader.c_str(), lrTable.c_str(), productions.c_str(), reader.userCode.c_str());
	fclose(outFile);
	return 0;
}

